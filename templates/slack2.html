<div style="padding: 20px; display: flex; flex-direction: column; height: 100%;">
    <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h2 style="margin: 0; color: #333;">Slack 발생 알람 빈도수 (알람종류별)</h2>
            <p style="color: #666; font-size: 0.9em; margin-top: 5px;">선택한 월의 일별 통계 내역입니다.</p>
        </div>
        <div style="background: #fff; padding: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            <label for="month-picker" style="font-weight: bold; margin-right: 10px;">조회월 선택:</label>
            <input type="month" id="month-picker"  
                   style="padding: 5px; border: 1px solid #ccc; border-radius: 4px;">
            <button onclick="window.onBtExport()" style="padding: 6px 15px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer;">Excel 다운로드</button>        
        </div>
    </div>

    <div id="grid-team1" class="ag-theme-alpine" style="flex-grow: 1; width: 100%; min-height: 400px;"></div>
</div>

<script>
    window.initPage = function(teamId) {
        const monthPicker = document.getElementById('month-picker');
        let gridApi;

        // 현재 날짜로 초기값 설정
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = String(now.getMonth() + 1).padStart(2, '0');
        const formattedDate = `${currentYear}-${currentMonth}`;
        monthPicker.value = formattedDate;

        // 그리드 설정
        const gridOptions = {
            columnDefs: [
                { field: "AlarmName", headerName: "알람구분", width: 300, pinned: 'left', filter: true },
                ...Array.from({length: 31}, (_, i) => ({
                    field: `d${String(i + 1).padStart(2, '0')}`,
                    headerName: String(i + 1).padStart(2, '0'),
                    width: 60,
                    type: 'numericColumn'
                })),
                { field: "total_count", headerName: "합계", width: 100, pinned: 'right', 
                  cellStyle: {fontWeight: 'bold', backgroundColor: '#f8f9fa'} }
            ],
            rowData: [],
            pagination: true,
            paginationPageSize: 20
        };

        // 그리드 생성
        const gridDiv = document.querySelector('#grid-team1');
        if (!gridDiv) {
            console.error('Grid container not found');
            return;
        }
        
        gridDiv.innerHTML = ''; 
        gridApi = agGrid.createGrid(gridDiv, gridOptions);

        // 데이터 로드 함수
        function fetchData(selectedMonth) {
            if (!gridApi) return;
            
            gridApi.showLoadingOverlay();
            
            fetch(`/api/query/${teamId}?month=${selectedMonth}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    gridApi.setGridOption('rowData', data);
                })
                .catch(error => {
                    console.error("Error:", error);
                    gridApi.setGridOption('rowData', []);
                    alert('데이터를 불러오는 중 오류가 발생했습니다.');
                });
        }

        // 이벤트 리스너
        monthPicker.addEventListener('change', (e) => {
            fetchData(e.target.value);
        });

        // 초기 데이터 로드
        fetchData(monthPicker.value);

        // 엑셀(CSV) 내보내기 함수
        window.onBtExport = function() {
            if (!gridApi) {
                console.error('Grid API not available');
                return;
            }
            
            const params = {
                fileName: `Slack_Alarm_${monthPicker.value}.csv`,
                columnSeparator: ','
            };
            gridApi.exportDataAsCsv(params);
        };
    };
</script>